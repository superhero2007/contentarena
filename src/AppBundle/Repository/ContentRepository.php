<?php

namespace AppBundle\Repository;


use AppBundle\Entity\Country;
use AppBundle\Entity\SalesPackage;
use AppBundle\Entity\Sport;
use AppBundle\Entity\Territory;
use AppBundle\Entity\ContentFilter;


/**
 * ContentRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ContentRepository extends \Doctrine\ORM\EntityRepository
{


    public function getSearchContent($value = null, $filter = null)
    {
        if($value){
            return $this->createQueryBuilder('c')
                ->leftJoin('c.company', 'com')
                ->leftJoin('c.sport', 's')
                ->leftJoin('c.tournament', 't')
                ->leftJoin('c.sportCategory', 'cat')
                ->where('c.eventType LIKE :value')
                ->orWhere('c.description LIKE :value')
                ->orWhere('c.releaseYear LIKE :value')
                ->orWhere('c.ownLicense LIKE :value')
                ->orWhere('c.brochure LIKE :value')
                ->orWhere('c.programName LIKE :value')
                ->orWhere('c.programType LIKE :value')
                ->orWhere('c.seriesType LIKE :value')
                ->orWhere('c.salesPackages LIKE :value')
                ->orWhere('c.distributionPackages LIKE :value')
                ->orWhere('com.legalName LIKE :value')
                ->orWhere('s.name LIKE :value')
                ->orWhere('t.name LIKE :value')
                ->orWhere('cat.name LIKE :value')
                ->setParameter('value', '%'.$value.'%')
                ->getQuery()
                ->getResult();

        }
        elseif($filter){
            $query = $this->createQueryBuilder('c')
                ->leftJoin('c.sport', 's');
            if(!empty($filter->sports)){
                $query->andWhere('s.externalId = :sport')
                    ->setParameter('sport',$filter->sports);
            }


            if(!empty($filter->timing)){
                if($filter->timing == 'upcoming'){
                    $date = date('Y-m-d h:i:s',time() - 3600 * 24 * 10);
                    $query->andWhere('c.expiresAt < :date')
                        ->setParameter('date',$date);
                }else if($filter->timing == 'recent'){
                    $date =date('Y-m-d h:i:s',time() - 3600 * 24 * 5);
                    $query->andWhere('c.createdAt = :date')
                        ->setParameter('date',$date);
                }else{
                    $date = json_decode($filter->timing);
                    $startDate = date('Y-m-d H:i:s',strtotime(str_replace(' ','-',$date->startDate)));
                    $endDate = date('Y-m-d H:i:s',strtotime(str_replace(' ','-',$date->endDate)));

                    $query->andWhere('c.createdAt >= :startDate')
                        ->andWhere('c.createdAt <= :endDate')
                        ->setParameter('startDate',$startDate)
                        ->setParameter('endDate',$endDate);
                }
            }

            return $query;
        }

    }

    public function getFilteredContent( ContentFilter $filter ){

        $query = $this->createQueryBuilder('content');

        if ( count( $filter->getSports() ) > 0 ) {
            $query
                ->innerJoin('content.sports', 'sports')
                ->where("sports IN(:sportList)")
                //->andWhere("content.approved = true")
                ->setParameter('sportList', $filter->getSports());
        }

        if ( count( $filter->getCountries() ) > 0 ) {
            $query
                ->leftJoin('content.salesPackages', 'salesPackages')
                ->leftJoin('salesPackages.selectedCountries', 'selectedCountries')
                ->andWhere($query->expr()->orX(
                    $query->expr()->eq('salesPackages.worldwide', '1'),
                    $query->expr()->in('selectedCountries', ':countries')
                ))
                ->setParameter('countries', $filter->getCountries());
        }

        if ( count( $filter->getSuperRights() ) > 0 ) {
            $query
                ->leftJoin('content.rightsPackage', 'rightsPackage')
                ->andWhere($query->expr()->orX(
                    $query->expr()->in('rightsPackage', ':rightsPackages')
                ))
                ->setParameter('rightsPackages', $filter->getSuperRights());
        }

        if ( $filter->getFromDate() != null && $filter->getToDate() != null ) {
            $query->andWhere('content.expiresAt >= :fromDate')
                ->andWhere('content.expiresAt <= :toDate')
                ->setParameter('fromDate',$filter->getFromDate())
                ->setParameter('toDate',$filter->getToDate());
        }

        $query->orderBy('content.'.$filter->getOrderBy(), $filter->getSortOrder());

        $result = $query->getQuery()->getResult();

        return $result;

    }

    public function getTerritoryInfo($customId){
        $data = [];
        $countriesRepository = $this->getEntityManager()->getRepository(Country::class);
        $territories = $this->getEntityManager()->getRepository(Territory::class)->findAll();
        $content = $this->findOneBy(['customId'=>$customId]);

        $salesPackages = $content->getSalesPackages();
        foreach($salesPackages as $index => $salesPackage){

            if(!$salesPackage->getSellAsPackage()){

                if( $salesPackage->isWorldwide() ){

                    $result = $countriesRepository->createQueryBuilder('c')
                        ->where('c.id >= 1')
                        ->getQuery()
                        ->getResult(2);

                } else {
                    $territories = array();
                    if ( count( $salesPackage->getSelectedCountries() ) > 0 ){
                        $result = $salesPackage->getSelectedCountries();
                    } elseif ( count( $salesPackage->getExcludedCountries() ) > 0 ){
                        $result = $salesPackage->getExcludedCountries();
                    }

                    foreach ( $result->getIterator() as $country ){
                        if ( !in_array( $country->getTerritory(),$territories, true ) ){
                            $territories[] = $country->getTerritory();
                        }
                    }
                }

                $data[] = [
                    'salesPackage'=>$salesPackage,
                    'countries'=>$result,
                ];
            }
        }

        $data['territories'] =$territories;

        return $data;
    }

    /**
     * @param SalesPackage[] $salesPackages
     * @return array
     */
    public function getBuyPackages($salesPackages){

        $data = [];

        if(count($salesPackages) > 0){

            foreach ($salesPackages as $salesPackage){

                if($salesPackage->getSellAsPackage() ){
                    $countries = [];
                    if( !$salesPackage->isWorldwide() ){

                        if( count( $salesPackage->getSelectedCountries() ) > 0){
                            $countries = $salesPackage->getSelectedCountries();
                        } elseif ( count( $salesPackage->getExcludedCountries() ) > 0 ){
                            $countries = $salesPackage->getExcludedCountries();
                        }

                    }

                    $data[] = [
                        'salesPackage'=>$salesPackage,
                        'countries'=>$countries,
                    ];

                }
            }

            return $data;
        }
        return [];
    }

    public function getExpiredData(){

        $now = date('Y-m-d H:i:s');

        return $this->createQueryBuilder('c')
            ->where('c.expiresAt < :now')
            ->setParameter('now',$now)
            ->orderBy('c.createdAt','DESC')
            ->getQuery()->getResult();
    }

    public function getContentInfo(){
        return $this->createQueryBuilder('c')
            ->where('c.id > :id')
            ->setParameter('id',1)
            ->getQuery()->getResult();
    }

}



